<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$ME Staking Revenue Share Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1A1B23;
            color: #ffffff;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 6px;
            background: linear-gradient(90deg, #E42575 0%, #7B2FF7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #8B8B93;
            font-size: 12px;
        }

        .controls-section {
            background: rgba(25, 26, 35, 0.8);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 180px 180px 180px;
            gap: 12px;
            align-items: end;
        }

        .control-group {
            min-width: 0;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: start;
        }

        .left-column {
            display: flex;
            flex-direction: column;
        }

        .right-column {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        @media (max-width: 1400px) {
            .controls-section {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .controls-section {
                grid-template-columns: 1fr;
            }
        }

        .control-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #8B8B93;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(20, 20, 28, 0.8);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.3s ease;
            text-align: left;
        }

        .control-input:focus {
            outline: none;
            border-color: #E42575;
            background: rgba(20, 20, 28, 1);
        }

        .control-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .snapshot-button-small {
            padding: 6px 12px;
            background: linear-gradient(90deg, #E42575 0%, #C91A60 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .snapshot-button-small:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(228, 37, 117, 0.4);
        }

        .snapshot-button-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-grid {
            display: contents;
        }

        .stat-card {
            background: rgba(25, 26, 35, 0.8);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 6px;
            padding: 14px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: rgba(228, 37, 117, 0.4);
            transform: translateY(-2px);
        }

        .stat-card.with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .stat-label {
            font-size: 10px;
            color: #8B8B93;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 26px;
            font-weight: 700;
            color: #fff;
        }

        .stat-value.highlight {
            background: linear-gradient(90deg, #E42575 0%, #7B2FF7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value.smaller {
            font-size: 13px;
        }

        .table-section {
            background: rgba(25, 26, 35, 0.6);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(123, 47, 247, 0.15) 0%, rgba(228, 37, 117, 0.15) 100%);
            border-bottom: 1px solid rgba(123, 47, 247, 0.2);
        }

        .table-header h2 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .table-header p {
            font-size: 11px;
            color: #8B8B93;
        }

        .table-controls {
            padding: 12px 20px;
            background: rgba(20, 20, 28, 0.5);
            border-bottom: 1px solid rgba(123, 47, 247, 0.1);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            background: rgba(20, 20, 28, 0.8);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #E42575;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-button {
            padding: 6px 12px;
            background: rgba(228, 37, 117, 0.2);
            border: 1px solid rgba(228, 37, 117, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-button:hover:not(:disabled) {
            background: rgba(228, 37, 117, 0.3);
            border-color: #E42575;
        }

        .pagination-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 12px;
            color: #8B8B93;
        }

        .per-page-select {
            padding: 6px 10px;
            background: rgba(20, 20, 28, 0.8);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .stakers-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stakers-table thead {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, rgba(123, 47, 247, 0.2) 0%, rgba(228, 37, 117, 0.2) 100%);
            z-index: 10;
        }

        .stakers-table th {
            padding: 15px 20px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
        }

        .stakers-table th:hover {
            background: rgba(228, 37, 117, 0.15);
        }

        .stakers-table td {
            padding: 15px 20px;
            font-size: 13px;
            border-bottom: 1px solid rgba(123, 47, 247, 0.1);
        }

        .stakers-table tbody tr:hover {
            background: rgba(228, 37, 117, 0.05);
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            color: #7B2FF7;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8B8B93;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(228, 37, 117, 0.2);
            border-top-color: #E42575;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 20px;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: rgba(228, 37, 117, 0.2);
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
        }

        .rank.top-3 {
            background: linear-gradient(90deg, #E42575 0%, #7B2FF7 100%);
            color: #fff;
        }

        .percentage {
            color: #E42575;
            font-weight: 600;
        }

        .sort-indicator {
            margin-left: 5px;
            font-size: 10px;
        }

        /* Tier Overview Section */
        .tier-section {
            background: rgba(25, 26, 35, 0.6);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 8px;
            padding: 16px;
            height: fit-content;
        }

        .tier-section h2 {
            font-size: 16px;
            margin-bottom: 6px;
        }

        .tier-section p {
            font-size: 11px;
            color: #8B8B93;
            margin-bottom: 14px;
        }

        .tier-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tier-card {
            background: rgba(25, 26, 35, 0.8);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 6px;
            padding: 12px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tier-card:hover {
            border-color: rgba(228, 37, 117, 0.5);
            transform: translateX(3px);
        }

        .tier-left {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .tier-sp {
            font-size: 15px;
            font-weight: 700;
            color: #7B2FF7;
        }

        .tier-percentage {
            font-size: 10px;
            color: #8B8B93;
        }

        .tier-right {
            text-align: right;
        }

        .tier-revenue {
            font-size: 16px;
            font-weight: 700;
            color: #E42575;
        }

        .tier-revenue-label {
            font-size: 9px;
            color: #8B8B93;
            margin-top: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Collapsible section */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(123, 47, 247, 0.15) 0%, rgba(228, 37, 117, 0.15) 100%);
            border-bottom: 1px solid rgba(123, 47, 247, 0.2);
            transition: background 0.3s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(123, 47, 247, 0.2) 0%, rgba(228, 37, 117, 0.2) 100%);
        }

        .collapsible-header h2 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .collapsible-header p {
            font-size: 11px;
            color: #8B8B93;
        }

        .collapse-toggle {
            font-size: 24px;
            transition: transform 0.3s ease;
        }

        .collapse-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* Cohort Analysis Section */
        .cohort-section {
            background: rgba(25, 26, 35, 0.6);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .cohort-section h2 {
            font-size: 16px;
            margin-bottom: 6px;
        }

        .cohort-section p {
            font-size: 11px;
            color: #8B8B93;
            margin-bottom: 14px;
        }

        .cohort-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }

        .cohort-card {
            background: rgba(25, 26, 35, 0.8);
            border: 1px solid rgba(123, 47, 247, 0.2);
            border-radius: 6px;
            padding: 14px;
            transition: all 0.3s ease;
        }

        .cohort-card:hover {
            border-color: rgba(228, 37, 117, 0.5);
            transform: translateY(-2px);
        }

        .cohort-range {
            font-size: 14px;
            font-weight: 700;
            color: #7B2FF7;
            margin-bottom: 8px;
        }

        .cohort-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .cohort-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .cohort-stat-label {
            font-size: 9px;
            color: #8B8B93;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cohort-stat-value {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
        }

        .cohort-revenue {
            padding-top: 10px;
            border-top: 1px solid rgba(123, 47, 247, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cohort-revenue-label {
            font-size: 10px;
            color: #8B8B93;
            text-transform: uppercase;
        }

        .cohort-revenue-value {
            font-size: 16px;
            font-weight: 700;
            color: #E42575;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ $ME Staking Revenue Share Dashboard</h1>
            <p>Track revenue distribution based on staking power (Monthly snapshot)</p>
        </div>

        <div class="controls-section">
            <div class="control-group">
                <label class="control-label">Monthly Net Revenue ($)</label>
                <input
                    type="number"
                    id="net-revenue-input"
                    class="control-input"
                    placeholder="Enter monthly net revenue"
                    value="0"
                    min="0"
                    step="1000"
                >
            </div>
            <div class="control-group">
                <label class="control-label">Revenue Share %</label>
                <input
                    type="number"
                    id="revenue-share-percentage"
                    class="control-input"
                    placeholder="15"
                    value="15"
                    min="0"
                    max="100"
                    step="0.5"
                >
            </div>
            <div class="control-group">
                <label class="control-label">Stakers Split %</label>
                <input
                    type="number"
                    id="stakers-split"
                    class="control-input"
                    placeholder="50"
                    value="50"
                    min="0"
                    max="100"
                    step="1"
                >
            </div>
            <div class="control-group">
                <label class="control-label">Buyback Split %</label>
                <input
                    type="number"
                    id="buyback-split"
                    class="control-input"
                    placeholder="50"
                    value="50"
                    min="0"
                    max="100"
                    step="1"
                >
            </div>
        </div>

        <div id="error-container"></div>

        <div class="main-layout">
            <!-- Left Column: Tier Section -->
            <div class="left-column">
                <div class="tier-section">
                    <h2>üíé Staking Power Tier Revenue Share</h2>
                    <p>See how much revenue share each staking power tier would receive monthly</p>
                    <div class="tier-grid" id="tier-grid">
                        <!-- Tier cards will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Stats -->
            <div class="right-column">
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Staking Power</div>
                        <div class="stat-value" id="total-staking-power">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Staked</div>
                        <div class="stat-value" id="total-staked">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Stakers</div>
                        <div class="stat-value" id="total-stakers">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" id="revenue-share-label">Total Revenue Share</div>
                        <div class="stat-value highlight" id="revenue-share">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" id="token-buyback-label">Token Buyback</div>
                        <div class="stat-value highlight" id="token-buyback">$0</div>
                    </div>
                    <div class="stat-card" style="border-color: rgba(239, 68, 68, 0.3);">
                        <div class="stat-label">Expiring Stake (Feb 2026)</div>
                        <div class="stat-value" style="color: #ef4444;" id="expiring-stake">-</div>
                        <div style="font-size: 12px; color: #8B8B93; margin-top: 8px;">
                            <span id="expiring-count">0</span> stakers ‚Ä¢ <span id="expiring-sp">0</span> SP
                        </div>
                    </div>
                    <div class="stat-card with-button">
                        <div>
                            <div class="stat-label">Last Updated</div>
                            <div class="stat-value smaller" id="last-updated">-</div>
                        </div>
                        <button id="snapshot-button" class="snapshot-button-small" onclick="fetchSnapshot()">
                            üì∏ Take Snapshot
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cohort Analysis Section -->
        <div class="cohort-section">
            <h2>üìä Staking Power Cohort Analysis</h2>
            <p>Distribution of stakers and revenue share across different staking power ranges</p>
            <div class="cohort-grid" id="cohort-grid">
                <!-- Cohort cards will be populated by JavaScript -->
            </div>
        </div>

        <div class="table-section">
            <div class="collapsible-header" onclick="toggleTable()">
                <div>
                    <h2>Individual Staker Revenue Distribution</h2>
                    <p>Detailed breakdown for all stakers</p>
                </div>
                <span class="collapse-toggle" id="collapse-toggle">‚ñº</span>
            </div>

            <div class="collapsible-content" id="table-collapsible">
                <div class="table-controls">
                <input
                    type="text"
                    id="search-input"
                    class="search-input"
                    placeholder="Search by wallet address..."
                    onkeyup="handleSearch()"
                >
                <div class="pagination-controls">
                    <select id="per-page-select" class="per-page-select" onchange="changePerPage()">
                        <option value="50">50 per page</option>
                        <option value="100" selected>100 per page</option>
                        <option value="250">250 per page</option>
                        <option value="500">500 per page</option>
                    </select>
                    <button class="pagination-button" onclick="previousPage()" id="prev-btn">‚Üê Prev</button>
                    <span class="pagination-info" id="page-info">-</span>
                    <button class="pagination-button" onclick="nextPage()" id="next-btn">Next ‚Üí</button>
                </div>
            </div>

            <div class="table-container">
                <table class="stakers-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('rank')">Rank <span class="sort-indicator" id="sort-rank"></span></th>
                            <th onclick="sortTable('wallet')">Wallet Address <span class="sort-indicator" id="sort-wallet"></span></th>
                            <th onclick="sortTable('stakingPower')">Staking Power <span class="sort-indicator" id="sort-stakingPower">‚ñº</span></th>
                            <th onclick="sortTable('staked')">Amount Staked <span class="sort-indicator" id="sort-staked"></span></th>
                            <th onclick="sortTable('percentage')">% of Total Power <span class="sort-indicator" id="sort-percentage"></span></th>
                            <th onclick="sortTable('revenueShare')">Revenue Share ($) <span class="sort-indicator" id="sort-revenueShare"></span></th>
                        </tr>
                    </thead>
                    <tbody id="stakers-tbody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div class="loading-spinner"></div>
                                <div>Loading staking data...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>
        </div>
    </div>

    <script>
        let stakingData = null;
        let currentSort = { column: 'stakingPower', ascending: false };
        let currentPage = 1;
        let perPage = 100;
        let searchQuery = '';
        const DATA_URL = 'staking-data.json'; // Load from local JSON file

        // Fetch staking data
        async function fetchStakingData() {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = '';

            try {
                const response = await fetch(DATA_URL);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const rawData = data.result.data.json;

                // Filter out stakers whose stake expires in February 2026
                // February 1, 2026 00:00:00 UTC = 1769904000
                // March 1, 2026 00:00:00 UTC = 1772323200
                const FEB_2026_START = 1769904000;
                const FEB_2026_END = 1772323200;

                const validStakers = [];
                const expiring = {
                    stakers: [],
                    totalStaked: 0,
                    totalStakingPower: 0,
                    count: 0
                };

                rawData.stakers.forEach(staker => {
                    if (staker.endTs >= FEB_2026_START && staker.endTs < FEB_2026_END) {
                        // Stake expires in February - invalid
                        expiring.stakers.push(staker);
                        expiring.totalStaked += staker.uiAmount;
                        expiring.totalStakingPower += staker.uiStakingPower;
                        expiring.count++;
                    } else {
                        // Valid stake
                        validStakers.push(staker);
                    }
                });

                // Create filtered staking data
                stakingData = {
                    ts: rawData.ts,
                    totalUIStaked: rawData.totalUIStaked - expiring.totalStaked,
                    totalLockups: rawData.totalLockups - expiring.count,
                    totalUIStakingPower: rawData.totalUIStakingPower - expiring.totalStakingPower,
                    stakers: validStakers,
                    expiring: expiring
                };

                updateStats();
                renderTable();

            } catch (error) {
                console.error('Error fetching staking data:', error);
                errorContainer.innerHTML = `
                    <div class="error">
                        <strong>‚ö†Ô∏è Error loading data:</strong> ${error.message}
                        <br><br>
                        <strong>Note:</strong> Make sure the web server is running and the staking-data.json file exists.
                    </div>
                `;
            }
        }

        // Get revenue share percentage
        function getRevenueSharePercentage() {
            return parseFloat(document.getElementById('revenue-share-percentage').value) || 15;
        }

        // Update stats cards
        function updateStats() {
            if (!stakingData) return;

            const netRevenue = parseFloat(document.getElementById('net-revenue-input').value) || 0;
            const sharePercentage = getRevenueSharePercentage();
            const stakersSplit = parseFloat(document.getElementById('stakers-split').value) || 50;
            const buybackSplit = parseFloat(document.getElementById('buyback-split').value) || 50;

            const totalToDistribute = netRevenue * (sharePercentage / 100);
            const revenueShare = totalToDistribute * (stakersSplit / 100);
            const tokenBuyback = totalToDistribute * (buybackSplit / 100);
            const stakersPercent = ((sharePercentage * stakersSplit) / 100).toFixed(1);
            const buybackPercent = ((sharePercentage * buybackSplit) / 100).toFixed(1);

            document.getElementById('total-staking-power').textContent =
                stakingData.totalUIStakingPower.toLocaleString(undefined, { maximumFractionDigits: 2 });

            document.getElementById('total-staked').textContent =
                stakingData.totalUIStaked.toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' $ME';

            document.getElementById('total-stakers').textContent =
                stakingData.stakers.length.toLocaleString();

            // Update labels with dynamic percentages
            document.getElementById('revenue-share-label').textContent =
                `Total Revenue Share (${stakersPercent}%)`;

            document.getElementById('token-buyback-label').textContent =
                `Token Buyback (${buybackPercent}%)`;

            document.getElementById('revenue-share').textContent =
                '$' + revenueShare.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            document.getElementById('token-buyback').textContent =
                '$' + tokenBuyback.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Update expiring stake info
            if (stakingData.expiring) {
                document.getElementById('expiring-stake').textContent =
                    stakingData.expiring.totalStaked.toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' $ME';
                document.getElementById('expiring-count').textContent =
                    stakingData.expiring.count.toLocaleString();
                document.getElementById('expiring-sp').textContent =
                    stakingData.expiring.totalStakingPower.toLocaleString(undefined, { maximumFractionDigits: 0 });
            }

            const date = new Date(stakingData.ts);
            document.getElementById('last-updated').textContent =
                date.toLocaleString();

            // Update tier cards and cohorts
            updateTierCards();
            updateCohorts();
        }

        // Update tier cards
        function updateTierCards() {
            if (!stakingData) return;

            const netRevenue = parseFloat(document.getElementById('net-revenue-input').value) || 0;
            const sharePercentage = getRevenueSharePercentage();
            const stakersSplit = parseFloat(document.getElementById('stakers-split').value) || 50;
            const totalToDistribute = netRevenue * (sharePercentage / 100);
            const totalRevenueShare = totalToDistribute * (stakersSplit / 100);
            const tierGrid = document.getElementById('tier-grid');

            // Define tiers (staking power amounts) - highest first
            const tiers = [1000000, 500000, 250000, 100000, 50000, 25000, 10000, 5000, 1000];

            tierGrid.innerHTML = tiers.map(sp => {
                const percentage = (sp / stakingData.totalUIStakingPower) * 100;
                const monthlyRevenue = (sp / stakingData.totalUIStakingPower) * totalRevenueShare;

                return `
                    <div class="tier-card">
                        <div class="tier-left">
                            <div class="tier-sp">${sp.toLocaleString()} SP</div>
                            <div class="tier-percentage">${percentage.toFixed(4)}% of total</div>
                        </div>
                        <div class="tier-right">
                            <div class="tier-revenue">$${monthlyRevenue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            <div class="tier-revenue-label">Monthly</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update cohort analysis
        function updateCohorts() {
            if (!stakingData) return;

            const netRevenue = parseFloat(document.getElementById('net-revenue-input').value) || 0;
            const sharePercentage = getRevenueSharePercentage();
            const stakersSplit = parseFloat(document.getElementById('stakers-split').value) || 50;
            const totalToDistribute = netRevenue * (sharePercentage / 100);
            const totalRevenueShare = totalToDistribute * (stakersSplit / 100);
            const cohortGrid = document.getElementById('cohort-grid');

            // Define cohort ranges (min to max SP)
            const cohorts = [
                { min: 1000000, max: Infinity, label: '1M+ SP' },
                { min: 500000, max: 1000000, label: '500K - 1M SP' },
                { min: 250000, max: 500000, label: '250K - 500K SP' },
                { min: 100000, max: 250000, label: '100K - 250K SP' },
                { min: 50000, max: 100000, label: '50K - 100K SP' },
                { min: 25000, max: 50000, label: '25K - 50K SP' },
                { min: 10000, max: 25000, label: '10K - 25K SP' },
                { min: 5000, max: 10000, label: '5K - 10K SP' },
                { min: 1000, max: 5000, label: '1K - 5K SP' },
                { min: 0, max: 1000, label: '0 - 1K SP' }
            ];

            // Calculate stats for each cohort
            const cohortData = cohorts.map(cohort => {
                const stakersInCohort = stakingData.stakers.filter(staker =>
                    staker.uiStakingPower >= cohort.min && staker.uiStakingPower < cohort.max
                );

                const totalSP = stakersInCohort.reduce((sum, staker) => sum + staker.uiStakingPower, 0);
                const percentOfTotal = (totalSP / stakingData.totalUIStakingPower) * 100;
                const cohortRevenue = (totalSP / stakingData.totalUIStakingPower) * totalRevenueShare;
                const avgRevenuePerUser = stakersInCohort.length > 0 ? cohortRevenue / stakersInCohort.length : 0;

                return {
                    ...cohort,
                    count: stakersInCohort.length,
                    totalSP,
                    percentOfTotal,
                    cohortRevenue,
                    avgRevenuePerUser
                };
            });

            // Render cohort cards
            cohortGrid.innerHTML = cohortData.map(cohort => `
                <div class="cohort-card">
                    <div class="cohort-range">${cohort.label}</div>
                    <div class="cohort-stats">
                        <div class="cohort-stat">
                            <div class="cohort-stat-label">Stakers</div>
                            <div class="cohort-stat-value">${cohort.count.toLocaleString()}</div>
                        </div>
                        <div class="cohort-stat">
                            <div class="cohort-stat-label">% of Total SP</div>
                            <div class="cohort-stat-value">${cohort.percentOfTotal.toFixed(2)}%</div>
                        </div>
                        <div class="cohort-stat">
                            <div class="cohort-stat-label">Avg/User</div>
                            <div class="cohort-stat-value">$${cohort.avgRevenuePerUser.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                    <div class="cohort-revenue">
                        <div class="cohort-revenue-label">Total Revenue Share</div>
                        <div class="cohort-revenue-value">$${cohort.cohortRevenue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle table collapse
        function toggleTable() {
            const content = document.getElementById('table-collapsible');
            const toggle = document.getElementById('collapse-toggle');

            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        // Get filtered and sorted stakers
        function getFilteredStakers() {
            if (!stakingData) return [];

            let filtered = [...stakingData.stakers];

            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(s =>
                    s.wallet.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }

            // Sort stakers
            const netRevenue = parseFloat(document.getElementById('net-revenue-input').value) || 0;
            const sharePercentage = getRevenueSharePercentage();
            const totalRevenueShare = (netRevenue * (sharePercentage / 100)) / 2;

            filtered.sort((a, b) => {
                let aVal, bVal;

                switch (currentSort.column) {
                    case 'stakingPower':
                        aVal = a.uiStakingPower;
                        bVal = b.uiStakingPower;
                        break;
                    case 'staked':
                        aVal = a.uiAmount;
                        bVal = b.uiAmount;
                        break;
                    case 'wallet':
                        aVal = a.wallet;
                        bVal = b.wallet;
                        return currentSort.ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    case 'percentage':
                        aVal = (a.uiStakingPower / stakingData.totalUIStakingPower) * 100;
                        bVal = (b.uiStakingPower / stakingData.totalUIStakingPower) * 100;
                        break;
                    case 'revenueShare':
                        aVal = (a.uiStakingPower / stakingData.totalUIStakingPower) * totalRevenueShare;
                        bVal = (b.uiStakingPower / stakingData.totalUIStakingPower) * totalRevenueShare;
                        break;
                    default:
                        aVal = a.uiStakingPower;
                        bVal = b.uiStakingPower;
                }

                return currentSort.ascending ? aVal - bVal : bVal - aVal;
            });

            return filtered;
        }

        // Render table with pagination
        function renderTable() {
            if (!stakingData) return;

            const tbody = document.getElementById('stakers-tbody');
            const netRevenue = parseFloat(document.getElementById('net-revenue-input').value) || 0;
            const sharePercentage = getRevenueSharePercentage();
            const stakersSplit = parseFloat(document.getElementById('stakers-split').value) || 50;
            const totalToDistribute = netRevenue * (sharePercentage / 100);
            const totalRevenueShare = totalToDistribute * (stakersSplit / 100);

            const allStakers = getFilteredStakers();
            const totalStakers = allStakers.length;
            const totalPages = Math.ceil(totalStakers / perPage);

            // Ensure current page is valid
            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

            const startIndex = (currentPage - 1) * perPage;
            const endIndex = Math.min(startIndex + perPage, totalStakers);
            const pageStakers = allStakers.slice(startIndex, endIndex);

            // Render rows
            tbody.innerHTML = pageStakers.map((staker, pageIndex) => {
                const globalIndex = startIndex + pageIndex;
                const percentage = (staker.uiStakingPower / stakingData.totalUIStakingPower) * 100;
                const individualShare = (staker.uiStakingPower / stakingData.totalUIStakingPower) * totalRevenueShare;
                const rank = globalIndex + 1;

                return `
                    <tr>
                        <td><span class="rank ${rank <= 3 ? 'top-3' : ''}">${rank}</span></td>
                        <td><span class="wallet-address">${staker.wallet}</span></td>
                        <td>${staker.uiStakingPower.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
                        <td>${staker.uiAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })} $ME</td>
                        <td><span class="percentage">${percentage.toFixed(4)}%</span></td>
                        <td>$${individualShare.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                `;
            }).join('');

            // Update pagination controls
            document.getElementById('page-info').textContent =
                `${startIndex + 1}-${endIndex} of ${totalStakers.toLocaleString()}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;

            updateSortIndicators();
        }

        // Pagination functions
        function nextPage() {
            currentPage++;
            renderTable();
        }

        function previousPage() {
            currentPage--;
            renderTable();
        }

        function changePerPage() {
            perPage = parseInt(document.getElementById('per-page-select').value);
            currentPage = 1;
            renderTable();
        }

        function handleSearch() {
            searchQuery = document.getElementById('search-input').value;
            currentPage = 1;
            renderTable();
        }

        // Sort table
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = false;
            }
            currentPage = 1; // Reset to first page when sorting
            renderTable();
        }

        // Update sort indicators
        function updateSortIndicators() {
            document.querySelectorAll('.sort-indicator').forEach(el => el.textContent = '');
            const indicator = document.getElementById(`sort-${currentSort.column}`);
            if (indicator) {
                indicator.textContent = currentSort.ascending ? '‚ñ≤' : '‚ñº';
            }
        }

        // Fetch snapshot from API
        async function fetchSnapshot() {
            const button = document.getElementById('snapshot-button');
            const errorContainer = document.getElementById('error-container');

            button.disabled = true;
            button.innerHTML = '‚è≥ Fetching...';
            errorContainer.innerHTML = '';

            try {
                const response = await fetch('/api/fetch-snapshot');
                const result = await response.json();

                if (result.success) {
                    // Show success message
                    errorContainer.innerHTML = `
                        <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 20px; color: #10b981; margin-bottom: 20px;">
                            <strong>‚úÖ ${result.message}</strong><br>
                            Reloading dashboard with updated data...
                        </div>
                    `;

                    // Reload the page after a short delay to show the new data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to fetch snapshot');
                }

            } catch (error) {
                console.error('Error:', error);
                errorContainer.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 20px; color: #ef4444; margin-bottom: 20px;">
                        <strong>‚ùå Error:</strong> ${error.message}<br>
                        <small>Make sure the server is running with <code>python3 server.py</code></small>
                    </div>
                `;
                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

                button.disabled = false;
                button.innerHTML = 'üì∏ Take Snapshot';
            }
        }

        // Update calculations when revenue input changes
        document.getElementById('net-revenue-input').addEventListener('input', () => {
            updateStats();
            renderTable();
        });

        // Update calculations when revenue share percentage changes
        document.getElementById('revenue-share-percentage').addEventListener('input', () => {
            updateStats();
            renderTable();
        });

        // Update calculations when split percentages change
        document.getElementById('stakers-split').addEventListener('input', () => {
            updateStats();
            renderTable();
        });

        document.getElementById('buyback-split').addEventListener('input', () => {
            updateStats();
            renderTable();
        });

        // Load data on page load
        fetchStakingData();
    </script>
</body>
</html>
